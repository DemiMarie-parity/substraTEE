# substraTEE

[substrate](https://docs.substrate.dev/) runtime in Trusted Execution Environment

*substraTEE* is an extension to [Parity Substrate](https://docs.substrate.dev/), allowing to call a custom state transition function inside a Trusted Execution Environment (TEE), namely an Intel SGX enclave thereby providing confidentiality and integrity. The enclaves operate on an encrypted state which can be read and written only by a set of provisioned and remote-attested enclaves.
*substraTEE* enables use cases demanding transaction privacy as well as atomic cross-chain transfers (bridges).

![vision](./substraTEE-vision.png)

What substraTEE aims to provide:

* confidential decentralized state transition functions
  * private transactions
  * private smart contracts
  * off-chain confidential personal data records (GDPR)
* scalability by providing a 2nd layer to substrate-based blockchains
  * off-chain smart contracts
  * payment hubs
* trusted chain bridges
* trusted oracles

## Concept Study

Different use cases for TEE's and potential software architectures have been analyzed and compared in [CONCEPTS](./CONCEPTS.md).
In the following we'll refer to the *substraTEE-worker* architecture, which has been implemented because it supports the widest range of use cases.

An overview over security aspects can be found in [SECURITY](./SECURITY.md). Remote attestation deviates from the usual Intel SGX scenario and is presented in [ATTESTATION](./ATTESTATION.md)

## Roadmap

### M1 PoC1: single-TEE confidential state transition function
off-chain worker runs STF within an Intel SGX enclave. The state is persisted in a sealed file which can only be read by that very enclave.

The demo STF will be a simple counter.

### M2 PoC2: single-TEE confidential state transition function in WASM
In addition to M1, the STF is defined by WASM code which is run by a WASMI interpreter within an Intel SGX enclave.

The demo STF will be a simple counter.

### M3 simple enclave provisioning
multiple workers can be assigned to a particular STF (contract). Only one of the enclaves will be master, the others serve as a failover backup.
Additional enclaves join by supplying remote attestation (RA) from Intel IAS and get group keys from partially trusted provisioning services (PS).

### M4 enclave provisioning
Enhanced provisioning (get rid of partially trusted PS).

enclave joins by supplying RA. With every enclave membership change group keys are renewed using dynamic peer group key agreement among enclaves.

### *M5 support for ink contracts*

*(development not yet funded)*

[ink!](https://medium.com/block-journal/introducing-substrate-smart-contracts-with-ink-d486289e2b59) is substrate's domain specific contract language on top of Rust. This milestone shall bring ink! contracts to substraTEE.

### future

* performance benchmarks and optimization
* testnet for stress-tests and showcasing
* use cases: bridges, payment hubs, ...

## Overview M1

The high level architecture of the current implementation can be seen in the following diagram:

![Diagram](./substraTEE-worker-overview.svg)

The main building blocks can be found in the following repositories:

* [substraTEE-node](https://github.com/scs/substraTEE-node): (custom substrate node) A substrate node with a custom runtime module
* [substraTEE-worker](https://github.com/scs/substraTEE-worker) (client, worker-app, worker-enclave): A SGX-enabled service that performs a confidential state-transition-function

## Demo

This repo hosts docker files to showcase the milestones.

### M1 PoC1: single-TEE confidential state transition function
The following requirements are needed to run the M1 demo:
* Docker installed
* Active internet connection

To build and execute the code, follow these instructions:
1. Clone the [substraTEE](https://github.com/scs/substraTEE) repository to your favorite location:
   ```
   $ git clone https://github.com/scs/substraTEE.git
   ```
2. Build the docker image:
   ```
   $ docker build -t substratee -f DockerfileM1 .
   ```
   This may take some time (~2h on a recent MacBook), so grab a cup of :coffee: or :tea: - or two.
3. Start the docker image and get an interactive shell:
   ```
   $ docker run -v $(pwd):/substraTEE/backup -ti substratee
   ```
   The `-v $(pwd):/substraTEE/backup` is used to save the files generated by the enclave for later use and can also be omitted.

   If you are in a PowerShell on Windows, replace the `$(pwd)` with `${PWD}`.
4. Start the development substraTEE-node in the background and log the output in a file:
   ```
   root@<DOCKERID>:/substraTEE# /substraTEE/substraTEE-node-M1/target/release/substratee-node --dev > node.log 2>&1 &
   ```
   The node now runs in the background and the output can be inspected by calling: `tail -f /substraTEE/node.log`.
5. Start the substraTEE-worker and generate the keys:
   ```
   root@<DOCKERID>:/substraTEE# cd /substraTEE/substraTEE-worker-M1
   root@<DOCKERID>:/substraTEE/substraTEE-worker-M1# ./bin/substratee_worker getpublickey
   root@<DOCKERID>:/substraTEE/substraTEE-worker-M1# ./bin/substratee_worker getsignkey
   ```
   This will generate the sealed (= encrypted) RSA3072 keypair (`./bin/rsa3072_key_sealed.bin`), the sealed ED25519 keypair (`./bin/ed25519_key_sealed.bin`) and the unencrypted public keys (`./bin/rsa_pubkey.txt` and `./bin/ecc_pubkey.txt`). The sealed keypairs can only be decrypted by your specific SGX enclave.
6. Start the substraTEE-worker in the background and log the output in a file:
   ```
   root@<DOCKERID>:/substraTEE/substraTEE-worker-M1# ./bin/substratee_worker worker > /substraTEE/worker.log 2>&1 &
   ```
   The worker now runs in the background and the output can be inspected by calling: `tail -f /substraTEE/worker.log`.
7. Start the substraTEE-client to send an extrinsic to the substraTEE-node that is then forwarded and processed by the substraTEE-worker (incrementing a counter):
   ```
   root@<DOCKERID>:/substraTEE/substraTEE-worker-M1# ./bin/substratee_client | tee /substraTEE/client.log
   ```
   The output of the client is also logged to the file `/substraTEE/client.log` and can be inspected by `less /substraTEE/client.log`.

   You will see on the last lines of the output the two hashes of the transaction (expected and actual). These should match indicating that all commands were processed successfully.
   ```
   Expected Hash: [...]
   Actual Hash:   [...]
   ```
8. Query the counter from the substraTEE-worker:
   ```
   root@<DOCKERID>:/substraTEE/substraTEE-worker-M1# ./bin/substratee_client getcounter | tee /substraTEE/counter.log
   ```

Whenever you perform the steps 7. and 8., you will see the counter incrementing.

#### IMPORTANT
If you exit the container (`exit`), you will loose the sealed counter state and the generated keys.

To backup the files:
```
root@<DOCKERID>:/substraTEE# cp /substraTEE/substraTEE-worker-M1/bin/*.txt /substraTEE/backup/
root@<DOCKERID>:/substraTEE# cp /substraTEE/substraTEE-worker-M1/bin/*.bin /substraTEE/backup/
```

To restore the files:
```
root@<DOCKERID>:/substraTEE# cp /substraTEE/backup/*.txt /substraTEE/substraTEE-worker-M1/bin/
root@<DOCKERID>:/substraTEE# cp /substraTEE/backup/*.bin /substraTEE/substraTEE-worker-M1/bin/
```

#### Enabling SGX HW support
The code is compiled for [Simulation Mode](https://software.intel.com/en-us/blogs/2016/05/30/usage-of-simulation-mode-in-sgx-enhanced-application) meaning that you don't need an actual SGX platform to run the example. This is specified in the `DockerfileM1` on line 99 (`SGX_MODE=SW make`). If you are on a platform that supports the SGX, you can enable HW support by:
  * Installing the Intel SGX Driver 2.5 and make sure that `/dev/isgx` appears
  * Start the docker with SGX device support:
    ```
    $ docker run -v $(pwd):/substraTEE/backup -ti --device /dev/isgx substratee
    ```
  * Start the aesm service inside the docker:
    ```
    root@<DOCKERID>:/# LD_LIBRARY_PATH=/opt/intel/libsgx-enclave-common/aesm /opt/intel/libsgx-enclave-common/aesm/aesm_service &
    ```
  * Compile the substraTEE-worker with HW support:
    ```
    root@<DOCKERID>:/substraTEE/substraTEE-worker-M1# make
    ```
  * Re-run from demo from step 5.

If you run the Hardware Mode on a platform that does not support SGX, you get the following error from the substraTEE-worker
```
*** Start the enclave
[2019-05-15T05:15:03Z ERROR substratee_worker::enclave_wrappers] [-] Init Enclave Failed SGX_ERROR_NO_DEVICE!
```

#### Enabling Debug output
To enable debug output, call the substraTEE-worker or the substraTEE-client with the following command, respectivly: `RUST_LOG=debug ./bin/substratee_client`.

## Acknowledgements

The development of substraTEE is financed by [web3 foundation](https://web3.foundation/)'s grant programme.

We also thank the teams at

* [Parity Technologies](https://www.parity.io/) for building [substrate](https://github.com/paritytech/substrate) and supporting us during development.
* [Baidu's Rust-SGX-SDK](https://github.com/baidu/rust-sgx-sdk) for their very helpful support and contributions.
